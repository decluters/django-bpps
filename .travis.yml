language: python
python:
  - 3.7

services:
    - docker

before_install: 
  - openssl aes-256-cbc -K $encrypted_a1430f60b6d9_key -iv $encrypted_a1430f60b6d9_iv -in secrets.tar.enc -out secrets.tar -d
  - tar xvf secrets.tar

install:
# 1. build (docker-compose) & 2. run (docker-compose)
  - make travis-build-up

script:
# 3. test (unit-tests APP)
  - make travis-test-unit
# 3.1 test (integration-tests)
# 4. Bundle & Push (docker-compose)
  - make travis-bundle-push

before_deploy:
# https://archive.ph/RKocC
  - openssl aes-256-cbc -K $encrypted_a1430f60b6d9_key -iv $encrypted_a1430f60b6d9_iv -in secrets.tar.enc -out secrets.tar -d
  - tar xvf secrets.tar
  - eval "$(ssh-agent -s)"
  - chmod 600 keychain/travis_id_rsa
  - ssh-add keychain/travis_id_rsa


# 5. Deploy
# https://gist.github.com/nickbclifford/16c5be884c8a15dca02dca09f65f97bd
deploy:
  provider: script
  script: bash deploy.sh dev
  on:
    branch: dev